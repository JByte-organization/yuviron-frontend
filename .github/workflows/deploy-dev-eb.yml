name: Deploy to AWS EB (dev)

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18  # Используем Node 18+, совместимый с Next 16

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js (standalone output)
        env:
          NODE_ENV: production  # гарантируем production-режим сборки
        run: npm run build

      - name: Copy static assets to standalone folder
        run: |
          cp -r public .next/standalone/ 
          cp -r .next/static .next/standalone/.next/

      - name: Prepare deployment artifact
        run: |
          # Добавляем Procfile и (при наличии) next.config.js в пакет
          echo "web: node .next/standalone/server.js" > Procfile
          [ -f next.config.js ] && cp next.config.js .next/standalone/ 
          # Архивируем содержимое .next/standalone в deploy.zip 
          cd .next/standalone && zip -r ../../deploy.zip * .[^.]*

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v22
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region: eu-west-2                      # регион AWS (пример)
          application_name: YourAppName          # имя приложения EB
          environment_name: yuviron-web-dev      # имя окружения EB (dev)
          version_label: yuviron-dev-${{ github.sha }}  # уникальная метка версии
          deployment_package: deploy.zip
